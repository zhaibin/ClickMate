# 日志系统说明

## 📋 概述

v1.3.2+ 版本引入了日志管理系统，v1.4.3+ 调整为仅记录软件异常（错误和警告），不记录用户行为，保护用户隐私。

## 📁 日志位置

### 开发环境
```
%USERPROFILE%\Documents\MouseControl\logs\
```

### 发布版本（便携版）
```
<应用目录>\logs\
```

## 📝 日志文件命名

- 格式：`app_YYYYMMDD.log`
- 示例：`app_20241121.log`
- 每天一个日志文件
- 自动清理7天前的旧日志

## 🔍 日志级别

自 v1.4.3+ 版本，日志系统仅记录异常情况，不记录用户行为：

| 级别 | 说明 | 使用场景 |
|------|------|----------|
| **WARNING** | 警告 | 非致命错误、权限问题、配置问题 |
| **ERROR** | 错误 | 异常、崩溃、DLL加载失败 |

**不再记录**：
- ~~DEBUG 调试信息~~（点击统计、参数变化等用户行为）
- ~~INFO 一般信息~~（启动、停止、配置变更等用户操作）

## 📊 日志内容

### 应用启动（系统信息）
```
[14:23:45.123] [WARNING] ========================================
[14:23:45.125] [WARNING] Logger system initialized - Exception-only mode
[14:23:45.126] [WARNING] Log file: E:\...\logs\app_20241121.log
[14:23:45.127] [WARNING] Version: v1.4.3
[14:23:45.128] [WARNING] Start time: 2024-11-21 14:23:45.128
[14:23:45.129] [WARNING] ========================================
```

### 警告日志（需要用户注意的问题）
```
[14:26:30.456] [WARNING] Cannot start - target position not set
[14:27:15.789] [WARNING] All hotkey registration failed - may need administrator permission or hotkey conflict
```

### 错误日志（软件异常）
```
[14:28:45.012] [ERROR  ] Hotkey system initialization failed - DLL load failed
[14:29:10.123] [ERROR  ] Hotkey check exception
Error: DllNotFoundException: Unable to load DLL 'mouse_controller.dll'
```

### 不再记录的内容
以下内容不再记录到日志文件，仅在控制台显示（如果使用调试模式）：
- 用户点击统计
- 启动/停止操作记录
- 热键触发记录
- 位置捕获记录
- 参数变更记录

## 🛠️ 查看日志

### 方法1：使用辅助脚本（推荐）
```bash
# 双击运行
查看日志.bat
```

自动显示最新日志的最后50行。

### 方法2：手动查看
```bash
# 打开logs目录
cd logs

# 用记事本打开最新日志
notepad app_20241121.log
```

### 方法3：使用PowerShell
```powershell
# 查看最后50行
Get-Content logs\app_20241121.log -Tail 50 -Encoding UTF8

# 实时监控（类似tail -f）
Get-Content logs\app_20241121.log -Wait -Tail 10 -Encoding UTF8
```

## 🔧 日志配置

### 当前配置
自 v1.4.3+ 版本，日志系统默认配置：
```dart
_logger = Logger(
  printer: _CustomLogPrinter(),
  output: _FileOutput(_logFile!),
  level: Level.warning,  // 仅记录 WARNING 和 ERROR
);
```

### 修改日志级别（不建议）
如需记录更多信息（如用于开发调试），编辑 `lib/logger_service.dart`:
```dart
level: Level.debug,  // 记录所有级别（包括用户行为）
```

### 修改保留天数
编辑 `lib/logger_service.dart`:
```dart
await _cleanOldLogs(logDir, keepDays: 7);  // 改为更大的值保留更久
```

## 📦 发布版本集成

便携版自动包含：
- `查看日志.bat` - 快速查看日志
- `调试启动.bat` - 调试模式启动
- `logs/` 目录 - 自动创建

## 🐛 故障排查

### 问题1：找不到日志文件
**原因**：程序可能没有成功启动

**解决**：
1. 使用"调试启动.bat"查看错误
2. 检查是否有权限创建logs目录
3. 尝试以管理员身份运行

### 问题2：日志文件为空
**原因**：日志系统初始化失败

**检查**：
1. 磁盘空间是否充足
2. 杀毒软件是否拦截文件写入
3. 目录权限是否正确

### 问题3：日志文件很小或为空
**说明**：v1.4.3+ 版本仅记录异常，正常运行时日志文件很小或为空是正常的

**解决**：
- 这不是问题！说明软件运行良好，没有异常
- 如果需要查看控制台输出，使用"调试启动.bat"
- 日志文件仅在出现错误或警告时才会写入内容

## 💡 最佳实践

### 用户反馈问题时
1. 要求用户运行"查看日志.bat"
2. 如果日志文件为空或很小，说明没有异常
3. 要求用户使用"调试启动.bat"重现问题，提供控制台输出
4. 或者直接发送日志文件（如果有内容）

### 开发调试时
1. 异常必须记录到 ERROR 级别
2. 需要用户注意的问题记录到 WARNING 级别
3. 不要记录用户行为（启动、停止、点击等）
4. 控制台输出（print）可以包含详细信息，但不会写入日志文件

### 日志内容建议
```dart
// ✅ 好的日志（记录异常）
LoggerService.instance.error('Hotkey system initialization failed - DLL load failed');
LoggerService.instance.warning('Cannot start - target position not set');

// ❌ 不好的日志（记录用户行为）
LoggerService.instance.info('Start auto-clicking');  // 不要记录
LoggerService.instance.debug('Click count: 10');      // 不要记录
```

## 📅 更新历史

- **v1.4.3** (2024-11-21)
  - **重大调整**：日志系统改为仅记录异常
  - 不再记录用户行为（点击、启动、停止等）
  - 仅保留 WARNING 和 ERROR 级别日志
  - 保护用户隐私，减少日志文件大小

- **v1.3.2** (2024-11-21)
  - 引入完整日志系统
  - 添加辅助查看脚本
  - 自动日志清理
  - DEBUG/INFO/WARNING/ERROR四级日志

---

**说明**：
- 日志文件以UTF-8编码保存，可用任何文本编辑器查看
- v1.4.3+ 版本正常运行时日志文件可能为空或很小（这是正常的）
- 如需查看详细运行信息，请使用"调试启动.bat"查看控制台输出

